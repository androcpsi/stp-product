{% extends "base.html" %}
{% block content %}

<div class="card card-modern p-4">
    <h4 class="mb-4">
        {% if is_edit %}
            Edit Product
        {% else %}
            Configurasi Product
        {% endif %}
    </h4>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <table class="table table-bordered align-middle">

            <tr>
                <th style="width:15%">Material Group</th>
                <td style="width:35%">
                    <input type="text" name="material_group" class="form-control"
                           value="{% if is_edit %}{{ product.material_group }}{% endif %}" readonly>
                </td>

                <th style="width:15%">Pack Size OLD</th>
                <td style="width:35%">
                    <input type="text" name="pack_size_old" class="form-control"
                           value="{% if is_edit %}{{ product.pack_size_old }}{% endif %}" readonly>
                </td>
            </tr>

            <tr>
                <th>Material Number</th>
                <td>
                    <input type="text"
                           name="material_number"
                           class="form-control bg-warning"
                           value="{% if is_edit %}{{ product.material_number }}{% endif %}"
                           {% if is_edit %}readonly{% endif %}>
                </td>

                <th>Length</th>
                <td>
                    <input type="number" step="0.01" name="length" class="form-control"
                           value="{% if is_edit %}{{ product.length }}{% endif %}" readonly>
                </td>
            </tr>

            <tr>
                <th>Material Description</th>
                <td>
                    <input type="text" name="material_description" class="form-control"
                           value="{% if is_edit %}{{ product.material_description }}{% endif %}" readonly>
                </td>

                <th>Width</th>
                <td>
                    <input type="number" step="0.01" name="width" class="form-control"
                           value="{% if is_edit %}{{ product.width }}{% endif %}" readonly>
                </td>
            </tr>

            <tr>
                <th></th>
                <td></td>

                <th>Height</th>
                <td>
                    <input type="number" step="0.01" name="height" class="form-control"
                           value="{% if is_edit %}{{ product.height }}{% endif %}" readonly>
                </td>
            </tr>

            <tr>
                <th>Base Unit</th>
                <td>
                    <input type="text" name="base_unit" class="form-control"
                           value="{% if is_edit %}{{ product.base_unit }}{% endif %}" readonly>
                </td>

                <th>Qty In Pallet</th>
                <td>
                    <input type="number" name="qty_in_pallet"
                           class="form-control bg-warning"
                           value="{% if is_edit %}{{ product.qty_in_pallet }}{% endif %}">
                </td>
            </tr>

            <tr>
                <th>Order Unit</th>
                <td>
                    <input type="text" name="order_unit" class="form-control"
                           value="{% if is_edit %}{{ product.order_unit }}{% endif %}" readonly>
                </td>

                <th>Qty In 1 Layers</th>
                <td>
                    <input type="number" name="qty_in_layers"
                           class="form-control bg-warning"
                           value="{% if is_edit %}{{ product.qty_in_layers }}{% endif %}">
                </td>
            </tr>

            <tr>
                <th>Sales Unit</th>
                <td>
                    <input type="text" name="sales_unit" class="form-control"
                           value="{% if is_edit %}{{ product.sales_unit }}{% endif %}" readonly>
                </td>

                <th>Qty Layers</th>
                <td>
                    <input type="number" name="qty_layers"
                           class="form-control bg-warning"
                           value="{% if is_edit %}{{ product.qty_layers }}{% endif %}">
                </td>
            </tr>

        </table>

        <hr>

        <div class="row text-center">

            <!-- 3D -->
            <div class="col-md-4">
                <h6>3D View</h6>

                <img id="preview_3d"
                     src="{% if is_edit and product.image_3d %}{{ product.image_3d }}{% endif %}"
                     class="img-fluid rounded shadow-sm mb-2 zoomable"
                     style="max-height:300px; cursor:pointer; {% if not is_edit or not product.image_3d %}display:none;{% endif %}">

                <input type="file" name="image_3d" id="input_3d" class="form-control">
            </div>

            <!-- BIRD -->
            <div class="col-md-4">
                <h6>Bird's Eye View</h6>

                <img id="preview_bird"
     src="{% if is_edit and product.image_bird %}{{ product.image_bird }}{% endif %}"
     class="img-fluid rounded shadow-sm mb-2 zoomable"
     style="max-height:300px; cursor:pointer; {% if not is_edit or not product.image_bird %}display:none;{% endif %}">

                <input type="file" name="image_bird" id="input_bird" class="form-control">
            </div>

            <!-- CARTON -->
            <div class="col-md-4">
                <h6>Carton View</h6>

                <img id="preview_carton"
     src="{% if is_edit and product.image_carton %}{{ product.image_carton }}{% endif %}"
     class="img-fluid rounded shadow-sm mb-2 zoomable"
     style="max-height:300px; cursor:pointer; {% if not is_edit or not product.image_carton %}display:none;{% endif %}">

                <input type="file" name="image_carton" id="input_carton" class="form-control">
            </div>

        </div>

        <button class="btn btn-primary mt-4">
            {% if is_edit %}
                Update
            {% else %}
                Submit
            {% endif %}
        </button>

    </form>
</div>

<!-- PREVIEW SCRIPT -->
<script>
function previewImage(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);

    if (!input || !preview) return;

    input.addEventListener("change", function () {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(this.files[0]);
        }
    });
}

previewImage("input_3d", "preview_3d");
previewImage("input_bird", "preview_bird");
previewImage("input_carton", "preview_carton");
</script>

<!-- MATERIAL AUTO FILL -->
<script>
document.querySelector('input[name="material_number"]').addEventListener('blur', function() {

    let materialNumber = this.value;
    if (!materialNumber) return;

    fetch(`/get-material-data/?material_number=${materialNumber}`)
    .then(response => response.json())
    .then(data => {

        if (data.error) {
            alert(data.error);
            return;
        }

        document.querySelector('input[name="material_group"]').value = data.material_group || '';
        document.querySelector('input[name="material_description"]').value = data.material_description || '';
        document.querySelector('input[name="pack_size_old"]').value = data.pack_size_old || '';
        document.querySelector('input[name="base_unit"]').value = data.base_unit || '';
        document.querySelector('input[name="order_unit"]').value = data.order_unit || '';
        document.querySelector('input[name="sales_unit"]').value = data.sales_unit || '';
        document.querySelector('input[name="length"]').value = data.length || '';
        document.querySelector('input[name="width"]').value = data.width || '';
        document.querySelector('input[name="height"]').value = data.height || '';

    })
    .catch(error => console.error('Error:', error));
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    const closeBtn = document.querySelector(".close-btn");

    if (!modal || !modalImg || !closeBtn) return;

    document.querySelectorAll(".zoomable").forEach(img => {
        img.addEventListener("click", function () {
            modal.style.display = "block";
            modalImg.src = this.src;
        });
    });

    closeBtn.addEventListener("click", function() {
        modal.style.display = "none";
    });

    modal.addEventListener("click", function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });

});
</script>

<!-- IMAGE MODAL -->
<div id="imageModal" class="image-modal">
    <span class="close-btn">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

{% endblock %}